
variational:
  minimizer:
    algorithm: RPCG
  iterations:
  - geometry: &geom
      geom_grid_file: ./soca_gridspec.nc
      mom6_input_nml: ./mom_input.nml
      fields metadata: ./fields_metadata.yml
    ninner: 20
    gradient norm reduction: 1e-3
    diagnostics:
      departures: ombg
    online diagnostics:
      write increment: true
      increment:
        state component:
          datadir: ./
          date: 2021-08-01T12:00:00Z
          exp: 3dfgat
          type: incr

cost function:
  cost type: 3D-FGAT
  time window:
    begin: 2021-08-01T00:00:00Z
    length: PT24H
  geometry: *geom
  analysis variables: &soca_an_vars
  - sea_water_potential_temperature
  - sea_water_salinity
  - sea_surface_height_above_geoid

  background:
    read_from_file: 1
    basename: ./bkg/
    ocn_filename: ocn.bkg.2019080112.nc
    date: &date 2021-08-01T00:00:00Z
    state variables:
    - sea_water_potential_temperature
    - sea_water_salinity
    - sea_surface_height_above_geoid
    - sea_water_cell_thickness
    - ocean_mixed_layer_thickness
    - sea_water_depth

  model:
    name: PseudoModel
    tstep: PT6H
    states:
    - read_from_file: 1
      date: 2021-08-01T06:00:00Z
      basename: ./bkg/
      ocn_filename: ocn.bkg.2019080112.nc
    - read_from_file: 1
      date: 2021-08-01T12:00:00Z
      basename: ./bkg/
      ocn_filename: ocn.bkg.2019080112.nc
    - read_from_file: 1
      date: 2021-08-01T18:00:00Z
      basename: ./bkg/
      ocn_filename: ocn.bkg.2019080112.nc
    - read_from_file: 1
      date: 2021-08-02T00:00:00Z
      basename: ./bkg/
      ocn_filename: ocn.bkg.2019080112.nc

  background error:
    covariance model: SABER
    saber central block:
      saber block name: diffusion
      read:
        groups:
        - variables:
          - sea_water_potential_temperature
          - sea_water_salinity
          horizontal:
            filepath: ./diffusion_hz
          vertical:
            levels: 75
            filepath: ./diffusion_vt
        - variables:
          - sea_surface_height_above_geoid
          horizontal:
            filepath: ./diffusion_hz

    linear variable change:
      input variables: *soca_an_vars
      output variables: *soca_an_vars
      linear variable changes:
      - linear variable change name: BkgErrGODAS
        sst_bgerr_file: ./godas_sst_bgerr.nc
        t_min: 0.05
        t_max: 2.0
        t_dz:  20.0
        t_efold: 500.0
        s_min: 0.01
        s_max: 0.25
        ssh_min: 0.0   # value at EQ
        ssh_max: 0.05   # value in Extratropics
        ssh_phi_ex: 20 # lat of transition from extratropics
        cicen_min: 0.1
        cicen_max: 0.5
        hicen_min: 10.0
        hicen_max: 100.0
      - linear variable change name: BalanceSOCA
        # kst:
        #   dsdtmax: 0.1
        #   dsdzmin: 3.0e-6
        #   dtdzmin: 1.0e-6
        #   nlayers: 10
        ksshts:
          nlayers: 2

  observations:
    observers:
    - obs space:
        name: sst_avhrr_metop-b
        obsdatain:
          engine:
            type: H5File
            obsfile: ./obs/20210801/obs.sst_avhrr_metop-c.20210801T120000Z.nc4
        obsdataout:
          engine:
            type: H5File
            obsfile: ./obs_out/3dfgat.sst_avhrr_metop-b.20210801T120000Z.nc4
        simulated variables: [seaSurfaceTemperature]
      obs operator:
        name: Identity
        observation alias file: ./obsop_name_map.yml
      obs error:
        covariance model: diagonal
      obs filters:
      - filter: Bounds Check
        minvalue: -1.8
        maxvalue: 40.0
      - filter: Background Check
        threshold: 4.0
      - filter: Domain Check
        where:
        - variable: {name: ObsError/seaSurfaceTemperature}
          minvalue: 0.001

    - obs space:
        name: ADT
        obsdatain:
          engine:
            type: H5File
            obsfile: ./obs/20210801/obs.adt_c2.20210801T120000Z.nc4
        obsdataout:
          engine:
            type: H5File
            obsfile: ./obs_out/3dfgat.adt_c2.20210801T120000Z.nc4
        simulated variables: [absoluteDynamicTopography]
      obs operator:
        name: ADT
      obs error:
        covariance model: diagonal
      obs filters:
      - filter: Bounds Check
        minvalue: -2.0
        maxvalue: 2.0
      - filter: Domain Check
        where:
        - variable: {name: GeoVaLs/sea_floor_depth_below_sea_surface}
          minvalue: 2000
      - filter: Background Check
        threshold: 4.0

final:
  diagnostics:
    departures: oman

output:
  datadir: ./
  exp: 3dfgat
  type: an